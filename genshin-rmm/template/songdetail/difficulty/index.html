<!DOCTYPE html>
<html lang="{[{@langcode-hyphen:str}]}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{{songtitle}}} - {[{pagetitle:html}]}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="/genshin-rmm/common.css" rel="stylesheet">
  <link href="/genshin-rmm/fonts/font.css" rel="stylesheet">
  <link rel="canonical" href="https://md-ndv356.github.io/genshin-rmm/{[{@langcode:str}]}/{{{songid}}}/{{{difficulty-id}}}/">
  {{{alternate-links}}}
  <style>
    #chart {
      position: relative;
      display: inline-block;
      text-align: center;
      width: 415px;
    }
    .tap {
      position: absolute;
      width: 26px; height: 26px;
      border-radius: 15px;
      border: solid 2px #ddd;
      background-color: #eabd59;
      z-index: 10;
    }
    .longedge {
      position: absolute;
      width: 26px; height: 26px;
      border-radius: 15px;
      border: solid 2px #ddd;
      background-color: #8f6eff;
      z-index: 10;
    }
    .longmid {
      position: absolute;
      width: 20px;
      background-color: #8f6effb3;
      translate: 5px 15px;
      z-index: 6;
    }
    .barline::before {
      position: absolute;
      right: 0;
      top: -14px;
      display: block;
      text-align: end;
      color: #6ef78f;
      content: attr(data-bpm);
    }
    .barline {
      position: absolute;
      font-family: "Micro 5", serif;
      font-size: 20px;
      translate: 0 4px;
      width: 24px;
      padding-right: 1px;
      text-align: end;
    }
    .barline::after {
      position: absolute;
      top: 0px; left: 25px;
      content: "";
      display: block;
      width: 390px; height: 2px;
      background-color: #ffffff80;
      z-index: 2;
      translate: 0 10px;
    }
    .barline.bpmchange::after {
      background-color: #7eff9c80;
    }
    .laneline {
      position: absolute;
      top: 0px; width: 1px;
      background-color: #ffffff80;
      z-index: 1;
    }
    .information {
      margin: 8px 12px 28px;
      padding: 8px;
      border: solid 2px #888;
      border-radius: 2px;
      background-color: #27343a;
    }
    #album {
      font-size: 14px;
      color: #ddd;
    }
    #title {
      font-size: 18px;
      font-weight: bold;
      margin: 4px 0;
    }
    #title {
      font-size: 18px;
      font-weight: bold;
      margin: 4px 0;
    }
    #title a {
      color: #b9ebfa;
      text-decoration: none;
    }
    #title-multi {
      display: flex;
      justify-content: center;
      flex-direction: column;
      border-collapse: collapse;
    }
    #title-multi > div {
      line-height: 1.25;
      margin: 1px 0;
    }
    .titlesublang {
      padding: 0 6px 0 0;
      font-size: 13px;
      color: #ddd;
      text-align: start;
    }
    .titlesub {
      padding: 0 0 0 0;
      font-size: 15px;
      text-align: start;
    }
    .others {
      display: flex;
      justify-content: center;
      gap: 14px;
      font-size: 15px;
      color: #eee;
    }
    .bpm {
      color: #ddd;
      font-size: 13px;
    }
    #bpm {
      margin: 0 4px;
    }
    #bpm-act {
      font-size: 13px;
    }
    .duration {
      color: #ddd;
      font-size: 13px;
      margin-right: 4px;
    }
    .notes {
      color: #ddd;
      font-size: 13px;
      margin-left: 4px;
    }
    .difficulty {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 5px 0 3px;
    }
    #bpm-notice {
      font-size: 14px;
      color: #ddd;
    }
    .flex {
      display: flex;
      align-items: baseline;
    }
  </style>
</head>
<body class="lang-{[{@langcode:str}]}">
<header>
  <div style="flex: 1;"><a href="/genshin-rmm/{[{@langcode:str}]}/" id="headtitle">{[{headtitle:html}]}</a></div>
  <div><select id="langselect">
    <option value="ja_jp">日本語</option>
    <option value="en_us">English</option>
    <option value="zh_cn">中文（简体）</option>
    <option value="zh_tw">中文（繁體）</option>
    <option value="ko_kr">한국어</option>
    <option value="es_es">Español</option>
    <option value="fr_fr">Français</option>
    <option value="ru_ru">Русский язык</option>
    <option value="th_th">ภาษาไทย</option>
    <option value="vi_vn">Tiếng Việt</option>
    <option value="de_de">Deutsch</option>
    <option value="id_id">Bahasa Indonesia</option>
    <option value="pt_pt">Português</option>
    <option value="tr_tr">Türkçe</option>
    <option value="it_it">Italiano</option>
  </select></div>
</header>
<main>
  <div class="information">
    <div id="album" title="{[{album_description:str}]}">{{{album}}}</div>
    <div id="title">{{{songtitle}}}</div>
    <div class="table-centering" id="title-multi">{{{songtitle_multilang}}}</div>
    <div class="difficulty">
      <div id="level-{{{difficulty-index}}}">{{{difficulty-text}}}</div>
      <div id="level-count">{{{level-stars}}}</div>
    </div>
    <div class="others">
      <div class="flex"><div class="bpm" title="{[{bpm_description:str}]}">BPM</div><div id="bpm">{{{bpm}}}</div><div id="bpm-act" title="{{{bpm-changes}}}">{{{bpm-minmax}}}</div></div>
      <div class="flex"><div class="duration">{[{duration:html}]}</div><div id="duration">{{{duration}}}</div></div>
      <div class="flex"><div id="notes"></div><div class="notes">{[{notes:html}]}</div></div>
    </div>
  </div>
  <p id="bpm-notice" {{{bpm-notice-style}}}>{[{bpm-notice:html}]}</p>
  <div id="chart"></div>
</main>
</body>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/sprintf/1.1.3/sprintf.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/i18next@25.1.2/i18next.min.jsjs"></script>
<script src="https://cdn.jsdelivr.net/npm/i18next-sprintf-postprocessor@0.2.2/i18nextSprintfPostProcessor.min.js"></script> -->
<script>
const langText = "{[{@langcode:str}]}";
// const params = Object.fromEntries(Array.from(new URLSearchParams(window.location.search).entries()));

const langselect = document.getElementById("langselect");
langselect.value = langText;
langselect.addEventListener("change", event => {
  query[0] = event.target.value;
  window.location = "https://md-ndv356.github.io/genshin-rmm/" + event.target.value + "/{{{songid}}}/{{{difficulty-id}}}/";
});

const speed = 200;

function init ([scoreData, measureData, bpmChangesData]){
  // Analyze Chart
  const tap       = ["1", "2", "3", "4", "5", "6"];
  const holdStart = ["q", "w", "e", "r", "t", "y"];
  const holdEnd   = ["a", "s", "d", "f", "g", "h"];
  let notesCount = 0;
  let notesAA = "";
  const holdStartPos = [null, null, null, null, null, null];
  const notesList = [];
  const barlineList = [];
  let basePosition = 0;
  const measureCount = scoreData.length;
  for (let barI = 0, barL = measureCount; barI < barL; barI++){
    const measureLength = measureData?.[barI] ? measureData[barI][0] / measureData[barI][1] : 1;
    const bar = scoreData[barI];
    const lines = bar.split(",");
    barlineList.push({ pos: basePosition, index: barI });
    for (let lineI = 0, lineL = lines.length; lineI < lineL; lineI++){
      const line = lines[lineI];
      const notePosition = basePosition + lineI / lineL;
      for (const note of line.split("")){
        const tapIndex = tap.indexOf(note);
        const holdStartIndex = holdStart.indexOf(note);
        const holdEndIndex = holdEnd.indexOf(note);
        if (tapIndex !== -1) notesList.push({type: "tap", pos: notePosition, lane: tapIndex});
        if (holdStartIndex !== -1) holdStartPos[holdStartIndex] = notePosition;
        if (holdEndIndex !== -1){
          const length = notePosition - holdStartPos[holdEndIndex];
          notesList.push({type: "hold", pos: notePosition, length, lane: holdEndIndex});
        }
      }
    }
    basePosition += measureLength;
  }

  // View Notes
  document.getElementById("notes").textContent = notesList.length + "";
  const chartBase = document.getElementById("chart");
  const height = notesList.at(-1).pos * speed;
  chartBase.style.height = (height + 35) + "px";
  for (let i = 0; i < 6; i++){
    chartBase.insertAdjacentHTML("beforeend", `<div class="laneline" style="left: ${44.5 + i * 70}px; height: ${height + 35}px;"></div>`);
  }
  for (const barline of barlineList){
    chartBase.insertAdjacentHTML("beforeend", `<div class="barline${bpmChangesData[barline.index] ? " bpmchange" : ""}" style="top: ${height - barline.pos * speed}px; left: 0px;" data-bpm="${bpmChangesData[barline.index] ?? ""}">${barline.index + 1}</div>`);
  }
  for (const note of notesList){
    const lanePos = 30 + note.lane * 70;
    if (note.type === "tap"){
      chartBase.insertAdjacentHTML("beforeend", `
<div class="tap" style="top: ${height - note.pos * speed}px; left: ${lanePos}px;"></div>`);
    } else if (note.type === "hold"){
      const holdStart = height - (note.pos - note.length) * speed;
      const holdEnd = height - note.pos * speed;
      chartBase.insertAdjacentHTML("beforeend", `
<div class="longedge" style="top: ${holdStart}px; left: ${lanePos}px;"></div>
<div class="longmid" style="top: ${holdEnd}px; left: ${lanePos}px; height: ${note.length * speed}px;"></div>
<div class="longedge" style="top: ${holdEnd}px; left: ${lanePos}px;"></div>`);
    }
  }
}


// for debug purpose
function play (){
  const currentTime = Date.now();
  scrollTo(0, play.startPos - (currentTime - play.startTime) * (play.bpm / 60000) * speed);
  if (!play.pause) requestAnimationFrame(play);
}
play.bpm = "{{{bpm}}}"-0;

// play.startTime = Date.now();
// play.startPos = document.querySelector("#chart").getBoundingClientRect().bottom + window.scrollY;
// play();

/**
 * Decodes a Base64-encoded, gzipped string back to its original Unicode string format.
 *
 * @param {string} base64GzippedString The input Base64 string.
 * @returns {Promise<string>} The decompressed Unicode string.
 * @author ChatGPT
 */
async function decodeBase64GzipUnicode(base64GzippedString) {
  // 1. Decode the Base64 string to a Uint8Array
  const binaryString = atob(base64GzippedString);
  const gzippedBytes = Uint8Array.from(binaryString, m => m.charCodeAt(0));

  // 2. Decompress the gzipped bytes using DecompressionStream
  // Convert the Uint8Array to a stream (using a Blob for cross-browser compatibility)
  const stream = new Blob([gzippedBytes]).stream();
  const decompressedStream = stream.pipeThrough(new DecompressionStream("gzip"));

  // 3. Read the stream and decode the bytes to a Unicode string
  // Use a Response object to easily read the stream's array buffer
  const decompressedBuffer = await new Response(decompressedStream).arrayBuffer();
  const originalString = new TextDecoder().decode(decompressedBuffer);

  return originalString;
}

(async () => {
  Promise.all([
    decodeBase64GzipUnicode(`{{{score-gzip-b64}}}`).then(jsonStr => JSON.parse(jsonStr)),
    decodeBase64GzipUnicode(`{{{measure-gzip-b64}}}`).then(jsonStr => JSON.parse(jsonStr)),
    decodeBase64GzipUnicode(`{{{bpm-changes-gzip-b64}}}`).then(jsonStr => JSON.parse(jsonStr)),
  ]).then(init);
})();
</script>
</html>
